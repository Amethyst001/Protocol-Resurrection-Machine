import { json } from '@sveltejs/kit';
import type { RequestHandler } from './$types';
import { YAMLParser } from '$lib/server/yaml-parser';
import { SmartYAMLConverter } from '$lib/server/smart-yaml-converter';

export interface Diagnostic {
	line?: number;
	column?: number;
	severity: 'error' | 'warning' | 'info';
	message: string;
	suggestion?: string;
}

export const POST: RequestHandler = async ({ request }) => {
	const startTime = Date.now();

	try {
		const { yaml: rawInput, autoConvert } = await request.json();

		if (!rawInput || typeof rawInput !== 'string') {
			return json(
				{ error: 'Invalid request: yaml field is required and must be a string' },
				{ status: 400 }
			);
		}

		const parser = new YAMLParser();
		const diagnostics: Diagnostic[] = [];

		try {
			// Try to parse as-is first
			const validationResult = parser.validateComplete(rawInput);

			// Convert validation errors to diagnostics
			for (const error of validationResult.errors) {
				diagnostics.push({
					line: error.line,
					column: error.column,
					severity: 'error',
					message: error.message,
					suggestion: error.suggestion
				});
			}

			// Check response time (should be under 500ms)
			const duration = Date.now() - startTime;
			if (duration > 500) {
				console.warn(`Validation took ${duration}ms, exceeding 500ms target`);
			}

			return json({
				diagnostics,
				valid: diagnostics.length === 0,
				durationMs: duration
			});

		} catch (parseError) {
			// Parsing failed - check if we should offer auto-conversion
			const converter = new SmartYAMLConverter();

			// If autoConvert flag is true, convert and return
			if (autoConvert === true) {
				try {
					const convertedYaml = converter.convert(rawInput);
					const spec = parser.parse(convertedYaml);

					return json({
						diagnostics: [],
						valid: true,
						convertedYaml: convertedYaml,
						wasConverted: true,
						durationMs: Date.now() - startTime
					});
				} catch (conversionError) {
					// Conversion also failed
					diagnostics.push({
						line: 1,
						column: 1,
						severity: 'error',
						message: 'Auto-conversion failed: ' + (conversionError instanceof Error ? conversionError.message : 'Unknown error'),
					});

					return json({
						diagnostics,
						valid: false,
						durationMs: Date.now() - startTime
					});
				}
			}

			// Otherwise, offer to convert
			const error = parseError as any;
			diagnostics.push({
				line: error.line || 1,
				column: error.column || 1,
				severity: 'error',
				message: error.message || 'Failed to parse YAML',
				suggestion: 'This input may need formatting. Would you like to auto-convert it?'
			});

			return json({
				diagnostics,
				valid: false,
				canAutoConvert: true, // Signal that auto-conversion is available
				durationMs: Date.now() - startTime
			});
		}

	} catch (error) {
		return json(
			{
				error: error instanceof Error ? error.message : 'Validation failed',
				diagnostics: [{
					severity: 'error' as const,
					message: error instanceof Error ? error.message : 'Validation failed'
				}]
			},
			{ status: 500 }
		);
	}
};
