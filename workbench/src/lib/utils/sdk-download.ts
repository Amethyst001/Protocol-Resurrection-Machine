/**
 * SDK Download Utility
 * Generates and downloads a zip file containing all generated code
 */

import JSZip from 'jszip';

export interface GeneratedCode {
    typescript?: string;
    python?: string;
    go?: string;
    rust?: string;
}

/**
 * Generate README.md content for the SDK
 */
function generateReadme(protocolName: string): string {
    return `# ${protocolName} Protocol SDK

This SDK was auto-generated by the Protocol Resurrection Machine.

## ðŸ“¦ Contents

- \`/typescript/\` - TypeScript types, parser, and serializer
- \`/python/\` - Python parser and serializer  
- \`/go/\` - Go parser, serializer, and client
- \`/rust/\` - Rust parser and serializer

## ðŸš€ Quick Start

### TypeScript
\`\`\`bash
cd typescript
npm install
npm run build
\`\`\`

### Python
\`\`\`bash
cd python
pip install -r requirements.txt
python -m ${protocolName.toLowerCase().replace(/\s+/g, '_')}_parser
\`\`\`

### Go
\`\`\`bash
cd go
go mod init ${protocolName.toLowerCase().replace(/\s+/g, '_')}
go build
\`\`\`

### Rust
\`\`\`bash
cd rust
cargo build
\`\`\`

## ðŸ“š Documentation

Each language folder contains:
- **Parser**: Parses protocol messages from bytes
- **Serializer**: Serializes messages to bytes
- **Types**: Message type definitions

## ðŸ”§ Integration

Import the parser and serializer in your application:

\`\`\`typescript
// TypeScript
import { ${protocolName}Parser, ${protocolName}Serializer } from './${protocolName.toLowerCase()}';
\`\`\`

\`\`\`python
# Python
from ${protocolName.toLowerCase()}_parser import ${protocolName}Parser
from ${protocolName.toLowerCase()}_serializer import ${protocolName}Serializer
\`\`\`

\`\`\`go
// Go
import "${protocolName.toLowerCase()}"
\`\`\`

\`\`\`rust
// Rust
use ${protocolName.toLowerCase().replace(/\s+/g, '_')}::{Parser, Serializer};
\`\`\`

## ðŸ“„ License

Auto-generated code - use freely in your projects.

---

Generated by [Protocol Resurrection Machine](https://github.com/yourusername/protocol-resurrection-machine)
`;
}

/**
 * Download all generated code as a zip file
 */
export async function downloadSDK(
    protocolName: string,
    code: GeneratedCode
): Promise<void> {
    const zip = new JSZip();

    // Add README
    zip.file('README.md', generateReadme(protocolName));

    // TypeScript folder
    if (code.typescript) {
        const tsFolder = zip.folder('typescript');
        if (tsFolder) {
            tsFolder.file(`${protocolName.toLowerCase()}.ts`, code.typescript);
            tsFolder.file(
                'package.json',
                JSON.stringify(
                    {
                        name: `${protocolName.toLowerCase()}-sdk`,
                        version: '1.0.0',
                        description: `${protocolName} protocol implementation`,
                        main: 'dist/index.js',
                        types: 'dist/index.d.ts',
                        scripts: {
                            build: 'tsc',
                            test: 'node --test'
                        },
                        devDependencies: {
                            typescript: '^5.0.0'
                        }
                    },
                    null,
                    2
                )
            );
            tsFolder.file(
                'tsconfig.json',
                JSON.stringify(
                    {
                        compilerOptions: {
                            target: 'ES2020',
                            module: 'commonjs',
                            declaration: true,
                            outDir: './dist',
                            strict: true,
                            esModuleInterop: true
                        },
                        include: ['*.ts']
                    },
                    null,
                    2
                )
            );
        }
    }

    // Python folder
    if (code.python) {
        const pyFolder = zip.folder('python');
        if (pyFolder) {
            pyFolder.file(`${protocolName.toLowerCase()}_parser.py`, code.python);
            pyFolder.file('requirements.txt', '# No external dependencies required\n');
            pyFolder.file('__init__.py', `"""${protocolName} Protocol SDK"""\n`);
        }
    }

    // Go folder
    if (code.go) {
        const goFolder = zip.folder('go');
        if (goFolder) {
            goFolder.file(`${protocolName.toLowerCase()}.go`, code.go);
            goFolder.file(
                'go.mod',
                `module ${protocolName.toLowerCase()}\n\ngo 1.21\n`
            );
        }
    }

    // Rust folder
    if (code.rust) {
        const rustFolder = zip.folder('rust');
        if (rustFolder) {
            rustFolder.file('lib.rs', code.rust);
            rustFolder.file(
                'Cargo.toml',
                `[package]
name = "${protocolName.toLowerCase().replace(/\s+/g, '_')}"
version = "0.1.0"
edition = "2021"

[dependencies]
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
`
            );
        }
    }

    // Generate and download zip
    const blob = await zip.generateAsync({ type: 'blob' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `${protocolName.toLowerCase().replace(/\s+/g, '_')}_sdk.zip`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
